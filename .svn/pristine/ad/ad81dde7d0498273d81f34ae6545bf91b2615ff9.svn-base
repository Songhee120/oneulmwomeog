package com.astral.app.member;

import java.io.PrintWriter;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.apache.ibatis.reflection.SystemMetaObject;

import com.astral.action.Action;
import com.astral.action.ActionForward;
import com.astral.app.member.dao.MemberDAO;
import com.astral.app.member.dao.Profile_FilesDAO;
import com.astral.app.member.vo.MemberVO;
import com.astral.app.member.vo.Profile_FilesVO;

public class MemberJoinOkAction implements Action {

	@Override
	public ActionForward execute(HttpServletRequest req, HttpServletResponse resp) throws Exception {
		req.setCharacterEncoding("UTF-8");
		resp.setCharacterEncoding("UTF-8");

		ActionForward forward = null;
		
		MemberDAO m_dao = new MemberDAO();
		MemberVO m_vo = new MemberVO();
		
		Profile_FilesDAO f_dao = new Profile_FilesDAO();
		Profile_FilesVO f_vo = new Profile_FilesVO();
		
		HttpSession session = req.getSession();
		
		String code = (String)session.getAttribute("code");
		String user_code = req.getParameter("mean_tel");
		
		m_vo.setMem_id(req.getParameter("join_id"));
		m_vo.setMem_email(req.getParameter("join_email") + req.getParameter("sub_email"));
		m_vo.setMem_pw(req.getParameter("join_password"));
		m_vo.setMem_name(req.getParameter("name"));
		m_vo.setMem_nickname(req.getParameter("nickname"));
		m_vo.setMem_tel(req.getParameter("tel"));
		String mon = req.getParameter("mon");
		if(mon.length() == 1) {
			mon = "0" + mon;
		}
		m_vo.setMem_birth(req.getParameter("year") + mon + req.getParameter("day"));
		
		String profile_file_name = "user_img.jpg";
		
		/*PrintWriter out = resp.getWriter();
		resp.setContentType("text/html;charset=utf-8");
		
		if(user_code.equals(code)) {
			//회원가입 성공시 alert
			if(m_dao.join(m_vo)) {
				forward = new ActionForward();
				req.setAttribute("success", 1);
				forward.setRedirect(false);
				forward.setPath("/member/index.jsp");
			}else {
			//인증번호는 일치하지만 서버 문제로 회원 가입 실패
			//1. page는 인덱스로 돌려서 회원가입실패 알림
			//2. join페이지에서 실패를 알려 다시 시도
			}
		//코드가 틀리므로 join.jsp에서 페이지 이동 없이 경고
		}else {
		//페이지 이동 없이 msg를 날려 출력	
		}*/
		
		if (m_dao.join(m_vo) && user_code.equals(code)) {
			f_vo.setMem_no(m_dao.getMemberNumber(m_vo.getMem_id()));
			f_vo.setProfile_file_name(profile_file_name);
			f_dao.insertFile(f_vo);
			
			forward = new ActionForward();
			forward.setRedirect(false);
			forward.setPath("/member/MemberLogin.me");			
		} else {
			PrintWriter out = resp.getWriter();
			resp.setContentType("text/html;charset=utf-8");
			out.println("<script>");
			out.println("alert('회원가입 실패')");
			out.println("</script>");
			out.close();
		}

		return forward;
	}

}
