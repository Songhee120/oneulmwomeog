package com.astral.app.member.dao;

import java.util.HashMap;
import java.util.Random;

import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionFactory;

import com.astral.app.member.vo.MemberVO;
import com.astral.mybatis.config.SqlMapConfig;

public class MemberDAO {

	private static final int KEY = 3;

	SqlSessionFactory sessionf = SqlMapConfig.getSqlMapInstance();
	SqlSession sql_session;

	public MemberDAO() {
		// 세션 팩토리로 세션을 열어주고 모든 쿼리문은 auto 커밋으로 설정
		sql_session = sessionf.openSession(true);
	}

	// 회원가입
	public boolean join(MemberVO mem) {
		mem.setMem_pw(encrypt(mem.getMem_pw()));
		return sql_session.insert("mem.join", mem) == 1;
	}

	// 아이디검사
	public boolean checkId(String mem_id) {
		return (Integer) sql_session.selectOne("mem.checkId", mem_id) == 1;
	}

	// 로그인
	public boolean login(String mem_id, String mem_pw) {
		HashMap<String, String> mem = new HashMap<>();

		mem.put("mem_id", mem_id);
		mem.put("mem_pw", encrypt(mem_pw));

		return (Integer) sql_session.selectOne("mem.login", mem) == 1;
	}

	// 암호화
	public String encrypt(String pw) {

		String en_pw = "";
		for (int i = 0; i < pw.length(); i++) {
			en_pw += (char) (pw.charAt(i) * KEY);
		}
		return en_pw;
	}

	// 마이페이지
	public MemberVO myInfo(String mem_id) {
		return sql_session.selectOne("mem.myInfo", mem_id);
	}

	// 아이디 찾기
	public String searchMyId(String mem_name, String mem_email) {
		HashMap<String, String> mem = new HashMap<>();
		mem.put("mem_name", mem_name);
		mem.put("mem_email", mem_email);
		return sql_session.selectOne("mem.searchMyId", mem);
	}

	// 닉네임 중복검사
	public boolean checkNick(String mem_nickname) {
		return (Integer) sql_session.selectOne("mem.checkNick", mem_nickname) == 1;
	}

	// 닉네임 변경
	public boolean changeMyNick(String mem_id, String mem_nickname) {
		HashMap<String, String> mem = new HashMap<>();

		mem.put("mem_id", mem_id);
		mem.put("mem_nickname", mem_nickname);
		return (Integer) sql_session.update("mem.changeMyNick", mem) == 1;
	}

	// 전화번호 중복검사
	public boolean checkTel(String mem_tel) {
		return (Integer) sql_session.selectOne("mem.checkTel", mem_tel) == 1;
	}

	// 전화번호 변경
	public boolean changeMyTel(String mem_id, String mem_tel) {
		HashMap<String, String> mem = new HashMap<>();

		mem.put("mem_id", mem_id);
		mem.put("mem_tel", mem_tel);
		return (Integer) sql_session.update("mem.changeMyTel", mem) == 1;
	}

	// 이메일 중복검사
	public boolean checkEmail(String mem_email) {
		return (Integer) sql_session.selectOne("mem.checkEmail", mem_email) == 1;
	}

	// 이메일 변경
	public boolean changeMyEmail(String mem_id, String mem_email) {
		HashMap<String, String> mem = new HashMap<>();

		mem.put("mem_id", mem_id);
		mem.put("mem_email", mem_email);
		return (Integer) sql_session.update("mem.changeMyEmail", mem) == 1;
	}

	// 비밀번호 찾기 & 새 비밀번호 생성
	public boolean searchMyPw(String mem_id, String mem_name) {
		HashMap<String, String> mem = new HashMap<>();
		mem.put("mem_id", mem_id);
		mem.put("mem_name", mem_name);
		mem.put("mem_pw", makeNewPw());

		return (Integer) sql_session.update("mem.changeMyPw", mem) == 1;
	}

	// 비밀번호 랜덤 생성
	public String makeNewPw() {
		String pw = "";
		String nums = "0123456789";
		Random r = new Random();

		for (int i = 0; i < 8; i++) {
			pw += nums.charAt(r.nextInt(10));
		}
		return pw;
	}

	// 비밀번호 변경
	public boolean changeMyPw(String mem_id, String mem_pw, String mem_newpw) {
		HashMap<String, String> mem = new HashMap<>();
		mem.put("mem_id", mem_id);
		mem.put("mem_pw", mem_pw);
		mem.put("mem_pw", mem_newpw);
		return sql_session.update("mem.changeMyPw", mem) == 1;

	}

}
