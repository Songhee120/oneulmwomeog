<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Config 3.0//EN" "http//mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="review">
	<select id="memberSeq" parameterType="string" resultType="_int">
		SELECT MEM_NO FROM TBL_MEMBER WHERE MEM_ID = #{mem_id}
	</select>
	
	<select id="getSeq" resultType="_int">
		SELECT REVIEW_SEQ.CURRVAL FROM DUAL
	</select>
	
	<insert id="insertReview" parameterType="reviewVO">
		INSERT INTO TBL_REVIEW VALUES(REVIEW_SEQ.NEXTVAL, #{review_content}, #{mem_no}, 0, 0, SYSDATE, #{review_star}, #{res_name}, #{res_url}, #{review_done}, #{res_address})
	</insert>
	
	<select id="getBestReviews" resultType="reviewVO">
   		<![CDATA[SELECT * FROM (SELECT * FROM TBL_REVIEW WHERE (TO_CHAR(REVIEW_DATE, 'YYYYMMDD') = (SELECT TO_CHAR(SYSDATE, 'YYYYMMDD') FROM DUAL)) ORDER BY REVIEW_HEART DESC) WHERE ROWNUM < 13]]>           
	</select>
	
	<!--리뷰 정보 -->
	<select id="getAllDetails" parameterType="_int" resultType="reviewVO">
		SELECT * FROM TBL_REVIEW WHERE REVIEW_NO = #{review_no}
	</select>
	
	<!-- myreview에서 사용할 닉네임 -->
	<select id="getMemberNickName" parameterType="_int" resultType="string">
		SELECT TM.MEM_NICKNAME FROM TBL_MEMBER TM, TBL_REVIEW TR WHERE TM.MEM_NO = TR.MEM_NO AND TR.REVIEW_NO = #{review_no}
	</select>
	
	<!-- 음식점 주소 (띄워쓰기 2번째 문자열까지) -->
	<select id="getResAddress" parameterType="_int" resultType="string">
		SELECT SUBSTR(RES_ADDRESS,0,INSTR(RES_ADDRESS,' ',1,2)) FROM TBL_REVIEW WHERE REVIEW_NO = #{review_no}
	</select>
	
	<!-- 조회수 -->
	<update id="updateViews" parameterType="_int">
		UPDATE TBL_REVIEW
		SET REVIEW_VIEWS = REVIEW_VIEWS + 1
		WHERE REVIEW_NO = #{review_no}
	</update>
	
	<update id="heart_check" parameterType="map">
		UPDATE TBL_HEART
		SET HEART_CHECK = HEART_CHECK + 1
		WHERE REVIEW_NO = #{review_no} AND MEM_NO = #{mem_no}
	</update>
	
	<update id="heart_check_cancel" parameterType="map">
		UPDATE TBL_HEART
		SET HEART_CHECK = HEART_CHEK - 1
		WHERE REVIEW_NO = #{review_no} AND MEM_NO = #{mem_no}
	</update>
	
	<update id="modifyReview" parameterType="reviewVO">
		UPDATE TBL_REVIEW
		SET REVIEW_CONTENT = #{review_content}, REVIEW_STAR = #{review_star}, RES_NAME = #{res_name}, RES_URL = #{res_url}, RES_ADDRESS = #{res_address}, REVIEW_DONE = #{review_done}
		WHERE REVIEW_NO = #{review_no}
	</update>
	
	<delete id="deleteReview" parameterType="_int">
		DELETE FROM TBL_REVIEW WHERE REVIEW_NO = #{review_no}
	</delete>
	
   <select id="getNewReviews" parameterType="map"
      resultType="reviewVO">
      SELECT * FROM
      (SELECT ROWNUM R, D.* FROM
      (SELECT * FROM
      TBL_REVIEW ORDER BY REVIEW_DATE DESC) D) A
      WHERE A.R BETWEEN
      ${startRow} AND ${endRow}
   </select>

   <select id="getReviewCnt" resultType="_int">
      SELECT COUNT(*) FROM
      TABLE_BOARD
   </select>

   <!-- 상호명 검색 -->
   <select id="searchName" parameterType="map"
      resultType="reviewVO">
      SELECT * FROM (SELECT ROWNUM R, T.* FROM ((SELECT * FROM
      TBL_REVIEW WHERE RES_NAME LIKE '%'||#{review_search}||'%') ORDER BY REVIEW_DATE
      DESC) T) S
      WHERE S.R BETWEEN #{startRow} AND #{endRow}
   </select>

   <!-- 지역 검색 -->
   <select id="searchAddress" parameterType="map"
      resultType="reviewVO">
      SELECT * FROM (SELECT ROWNUM R, T.* FROM ((SELECT * FROM
      TBL_REVIEW WHERE RES_ADDRESS LIKE '%'||#{review_search}||'%') ORDER BY REVIEW_DATE
      DESC) T) S
      WHERE S.R BETWEEN #{startRow} AND #{endRow}
   </select>
   
   <!-- 리뷰작성 회원번호 -->
   <select id="getMemberNumber" parameterType="_int" resultType="_int">
      SELECT MEM_NO FROM TBL_REVIEW WHERE REVIEW_NO = #{review_no}
   </select>
   
   <!-- 작성자 게시글 수 업데이트 -->
   <update id="updateMemberReview" parameterType="map">
      UPDATE TBL_MEMBER
      SET MEM_REVIEW_CNT = MEM_REVIEW_CNT + #{review_cnt}
      WHERE MEM_NO = #{mem_no}
   </update>
   
   <!--자신의 리뷰개수 가져오기-->
   <select id="getConfirmCnt" parameterType="_int" resultType="_int">
	  SELECT COUNT(*) FROM TBL_REVIEW WHERE MEM_NO = #{mem_no} 
   </select>
   
   <!--리뷰 목록 가져오기-->
   <select id="getReviewConfirm" parameterType="map" resultType="reviewVO">
      SELECT * FROM (SELECT ROWNUM R, N.* FROM (SELECT * FROM TBL_REVIEW WHERE MEM_NO = #{mem_no} ORDER BY REVIEW_DATE DESC) N)S 
	  WHERE S.R BETWEEN #{startRow} AND #{endRow}
   </select>
</mapper>





