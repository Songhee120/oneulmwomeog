package com.astral.app.review;

import java.io.PrintWriter;
import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import com.astral.action.Action;
import com.astral.action.ActionForward;
import com.astral.app.member.dao.HistoryDAO;
import com.astral.app.member.vo.HistoryVO;
import com.astral.app.review.dao.FilesDAO;
import com.astral.app.review.dao.ReviewDAO;
import com.astral.app.review.vo.ReviewVO;
import com.oreilly.servlet.MultipartFilter;
import com.oreilly.servlet.MultipartRequest;
import com.oreilly.servlet.multipart.DefaultFileRenamePolicy;

public class ReviewWriteOkAction implements Action {

   @Override
   public ActionForward execute(HttpServletRequest req, HttpServletResponse resp) throws Exception {
      
	  req.setCharacterEncoding("UTF-8");
      resp.setCharacterEncoding("UTF-8");
      HttpSession session = req.getSession();
      FilesDAO f_dao = new FilesDAO();
      ReviewDAO r_dao = new ReviewDAO();
      HistoryDAO h_dao = new HistoryDAO();
      ReviewVO r_vo = new ReviewVO();
      HistoryVO h_vo = null;

      String saveFolder = "C:\\web_1530_YR\\project\\workspace\\astral\\WebContent\\upload";
      
      int fileSize = 5 * 1024 * 1024;

      MultipartRequest multi = null;
      
      multi = new MultipartRequest(req, saveFolder, fileSize, "UTF-8", new DefaultFileRenamePolicy());
      
      //회원이 선택한 음식점 번호
      int history_no = Integer.parseInt(multi.getParameter("history_no"));
      //회원이 선택한 음식점 번호를 통해 음식점 데이터를 가져온다.
      h_vo = h_dao.selectHistory(history_no);
      
      /*리뷰 데이터 저장*/
      //회원번호
      r_vo.setMem_no(r_dao.memberSeq((String)session.getAttribute("mem_id")));
      //작성한 글
      r_vo.setReview_content(multi.getParameter("review_content"));
      //평점
      r_vo.setReview_star(Integer.parseInt(multi.getParameter("star_grade")));
      //음식점 이름
      r_vo.setRes_name(h_vo.getRes_name());
      //음식점 주소
      r_vo.setRes_address(h_vo.getRes_address());
      //음식점 URL
      r_vo.setRes_url(h_vo.getRes_url());
      //리뷰 완성 여부
      r_vo.setReview_done(Integer.parseInt(multi.getParameter("success")));
      
      if(r_dao.insertReview(r_vo)) {
         if(f_dao.insertFiles(r_dao.getReviewSeq(), multi)) {
            ActionForward forward = new ActionForward();
            forward.setRedirect(true);
            forward.setPath(req.getContextPath() + "/member/login_index.jsp");
            
            return forward;
         }
      }
      
      PrintWriter out = resp.getWriter();
      resp.setContentType("text/html;charset=utf-8");

      out.println("<script>");
      out.println("alert('게시글 등록 실패. 다시 시도해주세요')");
      out.println("</script>");
      out.close();

      return null;
   }

}